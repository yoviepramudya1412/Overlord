{% extends 'base.html' %}
{% load static %}
{% block content %} 
{% include 'layout/sidebaradmin.html' %}
<link rel="stylesheet" href="{% static 'assets/css/decorate.css' %}" />
<link rel="stylesheet" href="{% static 'assets/css/peta.css' %}" />
<link rel="stylesheet" href="{% static 'assets/compiled/css/app.css' %}" />
<link rel="stylesheet" href="{% static 'assets/compiled/css/app-dark.css' %}" />
<link rel="stylesheet" href="{% static 'assets/compiled/css/iconly.css' %}" />
<!--Admin punya-->

<link rel="stylesheet" href="{% static 'assets/css/search.css' %}" />
<link rel="stylesheet" href="{% static 'assets/css/halo.css' %}" />

<link rel="stylesheet" href="{% static 'assets/css/leaflet-measure.css' %}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-print/dist/leaflet.print.css" />


<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-fullscreen@1.0.2/dist/leaflet.fullscreen.css"
/>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />


<style>
.leaflet-control-measure .leaflet-control-measure-toggle,
.leaflet-control-measure .leaflet-control-measure-toggle:hover {
    background-size: 10px 10px;
    background-image: url("{% static 'assets/image/ruler/rulers.png'%}");
    

}
.leaflet-retina .leaflet-control-measure .leaflet-control-measure-toggle,
.leaflet-retina .leaflet-control-measure .leaflet-control-measure-toggle:hover {
    background-image: url("{% static 'assets/image/ruler/rulers_@2X.png' %}")
}
.leaflet-control-measure a.start {
    
    background-image: url("{% static 'assets/image/ruler/start.png' %}");
    
}
.leaflet-retina .leaflet-control-measure a.start {
    background-image: url("{% static 'assets/image/ruler/start_@2X.png' %}")
}
.leaflet-control-measure a.cancel {
    
    background-image: url("{% static 'assets/image/ruler/cancel.png' %}");
    
}
.leaflet-retina .leaflet-control-measure a.cancel {
    background-image: url("{% static 'assets/image/ruler/cancel_@2X.png' %}")
}
.leaflet-control-measure a.finish {
    
    background-image: url("{% static 'assets/image/ruler/check.png' %}");
    
}
.leaflet-retina .leaflet-control-measure a.finish {
    background-image: url("{% static 'assets/image/ruler/check_@2X.png' %}")
}
.leaflet-measure-resultpopup a.zoomto {
    
    background-image: url("{% static 'assets/image/ruler/focus.png' %}");
    
}
.leaflet-retina .leaflet-measure-resultpopup a.zoomto {
    background-image: url("{% static 'assets/image/ruler/focus_@2X.png' %}")
}
.leaflet-measure-resultpopup a.deletemarkup {
    
    background-image: url("{% static 'assets/image/ruler/trash.png' %}");
    
}
.leaflet-retina .leaflet-measure-resultpopup a.deletemarkup {
    background-image: url("{% static 'assets/image/ruler/trash_@2X.png' %}")
}
</style>


{% if user.is_authenticated %}

<div class="page-heading">
    <h3>Dashboard</h3>
</div>
<div class="page-content">
    <section class="row">
    <div class="col-12 col-lg-9">
        <div class="row">
        <div class="col-6 col-lg-3 col-md-6">
            <div class="card">
            <div class="card-body px-4 py-4-5">
                <div class="row">
                <div
                    class="col-md-4 col-lg-12 col-xl-12 col-xxl-5 d-flex justify-content-start"
                >
                    <div class="stats-icon purple mb-2">
                    <i class="fa-solid fa-bolt" style="color: #ffffff;"></i>
                    </div>
                </div>
                <div class="col-md-8 col-lg-12 col-xl-12 col-xxl-7">
                    <a href="{% url 'export_kerusakan_to_excel' %}"><h6 class="text-muted font-semibold">
                    Kerusakan
                    </h6></a>
                    <h6 class="font-extrabold mb-0">{{kerusakan}}</h6>
                </div>
                </div>
            </div>
            </div>
        </div>
        <div class="col-6 col-lg-3 col-md-6">
            <div class="card">
            <div class="card-body px-4 py-4-5">
                <div class="row">
                <div
                    class="col-md-4 col-lg-12 col-xl-12 col-xxl-5 d-flex justify-content-start"
                >
                    <div class="stats-icon blue mb-2">
                    <i class="fa-solid fa-wind" style="color: #ffffff;"></i>
                    </div>
                </div>
                <div class="col-md-8 col-lg-12 col-xl-12 col-xxl-7">
                    <a href="{% url 'export_pengajuan_to_excel' %}"><h6 class="text-muted font-semibold">Pengajuan</h6></a>
                    <h6 class="font-extrabold mb-0">{{jumlah_data}}</h6>
                </div>
                </div>
            </div>
            </div>
        </div>
        <div class="col-6 col-lg-3 col-md-6">
            <div class="card">
            <div class="card-body px-4 py-4-5">
                <div class="row">
                <div
                    class="col-md-4 col-lg-12 col-xl-12 col-xxl-5 d-flex justify-content-start"
                >
                    <div class="stats-icon green mb-2">
                    <i class="fa-solid fa-file-invoice" style="color: #fff;"></i>
                    </div>
                </div>
                <div class="col-md-8 col-lg-12 col-xl-12 col-xxl-7">
                    <a href="{% url 'export_to_excelper' %}"><h6 class="text-muted font-semibold">Perencanaan</h6></a>
                    <h6 class="font-extrabold mb-0">{{data_perencanaan}}</h6>
                </div>
                </div>
            </div>
            </div>
        </div>
        <div class="col-6 col-lg-3 col-md-6">
            <div class="card">
            <div class="card-body px-4 py-4-5">
                <div class="row">
                <div
                    class="col-md-4 col-lg-12 col-xl-12 col-xxl-5 d-flex justify-content-start"
                >
                    <div class="stats-icon red mb-2">
                    <i class="fa-solid fa-building-lock" style="color: #ffffff;"></i>
                    </div>
                </div>
                <div class="col-md-8 col-lg-12 col-xl-12 col-xxl-7">
                    <a href="{% url 'export_to_excel' %}"><h6 class="text-muted font-semibold">Pembangunan</h6></a>
                    <h6 class="font-extrabold mb-0">{{data_pembangunan}}</h6>
                </div>
                </div>
            </div>
            </div>
        </div>
        </div>
        <div class="row">
        <div class="col-12">
            <div class="card">
            <div class="card-header">
                <h4>Monitoring Fasilitas Buruk</h4>
            </div>
            <div class="card-body">
                <div id="map" class="h-[480px] rounded-xl relative z-10   ">   
                    <div class="legend " id="legend-container">
                <h6>Legend</h6>
                <div class="legend-content">
                    <!-- Data legenda akan di-generate oleh JavaScript -->
                </div>
            </div>
                    
                
                <div class="layer-selector">
        <label for="layer-select">Select Layer:</label>
        <select id="layer-select">
            <option value="streets">Google Streets</option>
            <option value="hybrid">Google Hybrid</option>
            <option value="satellite">Google Satellite</option>
            <option value="terrain">Google Terrain</option>
        </select>                    
        

    </div>

            
        </div>
        
        
        
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js" async></script>
        <script src="https://unpkg.com/leaflet-draw"></script>
        <script src="https://unpkg.com/leaflet-fullscreen@1.0.2/dist/Leaflet.fullscreen.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>
        <script src="{% static 'assets/js/leaflet.browser.print.min.js' %}"></script>
        <script src="{% static 'assets/js/leaflet/leaflet-measure.js' %}"></script>


<script>
                    // Inisialisasi peta
        var map = L.map('map').setView([5.549037601496668, 95.31928497494027], 13);
        L.control.scale().addTo(map);
        map.addControl(new L.Control.Fullscreen());
        L.control.measure({ 
            position: 'topright',
            primaryLengthUnit: 'kilometers',
            secondaryLengthUnit: 'meters',
            primaryAreaUnit: 'hectares',
            secondaryAreaUnit: undefined
        }).addTo(map);
        L.control.locate().addTo(map);

        var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

var drawControl = new L.Control.Draw({
    draw: {
        polyline: true,
        polygon: true,
        circle: true,
        marker: false,
        circlemarker: false,
    },
    edit: {
        featureGroup: drawnItems,
        edit: true,
        remove: true,
    },
});

map.addControl(drawControl);

// Event listener untuk menangani ketika pengukuran selesai
map.on('draw:created', function (e) {
    var layer = e.layer;
    drawnItems.addLayer(layer);
});


            
        var googleStreets = L.tileLayer('http://{s}.google.com/vt?lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        var googleHybrid = L.tileLayer('http://{s}.google.com/vt?lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        var googleSatellite = L.tileLayer('http://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        var googleTerrain = L.tileLayer('http://{s}.google.com/vt?lyrs=p&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        var baseLayers = {
            'Google Streets': googleStreets,
            'Google Hybrid': googleHybrid,
            'Google Satellite': googleSatellite,
            'Google Terrain': googleTerrain
        };

        

        var layerSelect = document.getElementById('layer-select');
        layerSelect.addEventListener('change', function () {
            var selectedLayer = layerSelect.value;
            if (selectedLayer === 'streets') {
                map.addLayer(googleStreets);
                map.removeLayer(googleHybrid);
                map.removeLayer(googleSatellite);
                map.removeLayer(googleTerrain);
            } else if (selectedLayer === 'hybrid') {
                map.addLayer(googleHybrid);
                map.removeLayer(googleStreets);
                map.removeLayer(googleSatellite);
                map.removeLayer(googleTerrain);
            } else if (selectedLayer === 'satellite') {
                map.addLayer(googleSatellite);
                map.removeLayer(googleStreets);
                map.removeLayer(googleHybrid);
                map.removeLayer(googleTerrain);
            } else if (selectedLayer === 'terrain') {
                map.addLayer(googleTerrain);
                map.removeLayer(googleStreets);
                map.removeLayer(googleHybrid);
                map.removeLayer(googleSatellite);
            }
        });
        map.addLayer(googleStreets);
        
        function tampilkanMarker(markers) {
            markers.forEach(function(marker) {
                var latitude = marker.lat;
                var longitude = marker.lng;
                var konstruksi_selesai = marker.konstruksi_selesai;
                var nama_fasilitas = marker.nama_fasilitas;
                var ruasjalan = marker.ruasjalan;
                var kondisi = marker.kondisi;
                var gambar = marker.gambar;
                var color = marker.color;

                if (!gambar) {
                    // Gambar pengganti
                    gambar = '/assets/image/samples/banana.jpg' ;
                }
                var customIcon = L.divIcon({
                    className: 'custom-icon',
                    html: `<i class="fa-solid fa-location-dot fa-2xl" style="color: ${color}; "></i>`
                });

                var popupContent = `
                    <div class="custom-popup">
                        <div class="info">
                            <b>Nama Fasilitas</b>
                            <span>: ${nama_fasilitas}</span>
                        </div>
                        <div class="info">
                            <b>Ruas Jalan</b>
                            <span>: ${ruasjalan}</span>
                        </div>
                        <div class="info">
                            <b>Kondisi</b>
                            <span>: ${kondisi}</span>
                        </div>
                        <div class="info">
                            <b>Tanggal Selesai</b>
                            <span>: ${new Date(konstruksi_selesai).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                        </div>
                        
                        
                        <div class="image">
                            <img src="${gambar}" alt="Pengguna tidak mengupload image" title="Gambar Pengajuan">
                        </div>
                    </div>
                `;

                L.marker([latitude, longitude], { icon: customIcon })
                    .bindPopup(popupContent)
                    .addTo(map);
            });
        }
        

        // Data markers yang diteruskan dari Django
        var markers = [
            {% for marker in markers %}
                {
                    lat: {{ marker.lat }},
                    lng: {{ marker.lng }},
                    nama_fasilitas : '{{ marker.nama_fasilitas }}',
                    ruasjalan : '{{ marker.ruasjalan }}',
                    kondisi : '{{ marker.kondisi}}',
                    konstruksi_selesai : '{{ marker.konstruksi_selesai }}',
                    gambar: '{{ marker.gambar }}',
                    color: '{{ marker.color }}',
                },
            {% endfor %}
        ];

        // Memanggil fungsi tampilkanMarker dengan data markers
        tampilkanMarker(markers);

                
        function createLegend(markers) {
        var legendContent = document.querySelector('.legend-content');
        var addedFasilitas = {}; // Objek untuk melacak nama fasilitas yang sudah ditambahkan ke legend

        markers.forEach(function (marker) {
            var nama_fasilitas = marker.nama_fasilitas;
            var color = marker.color;

            // Cek apakah nama fasilitas sudah ada dalam objek addedFasilitas
            if (!addedFasilitas[nama_fasilitas]) {
            var legendItem = document.createElement('div');
            legendItem.classList.add('legend-item');

            var legendMarker = document.createElement('span');
            legendMarker.classList.add('legend-marker');
            legendMarker.style.backgroundColor = color;

            var legendText = document.createElement('span');
            legendText.innerText = nama_fasilitas;

            legendItem.appendChild(legendMarker);
            legendItem.appendChild(legendText);
            legendContent.appendChild(legendItem);

            addedFasilitas[nama_fasilitas] = true; // Tandai bahwa nama fasilitas sudah ditambahkan ke legend
            }
        });
        }
// Memanggil fungsi createLegend dengan data markers
createLegend(markers);


    

    

    
// Fungsi untuk menampilkan legenda pada peta
function showLegend() {
    var legend = document.querySelector('.legend-content');
    legend.style.display = 'block';
}

// Fungsi untuk menyembunyikan legenda pada peta
function hideLegend() {
    var legend = document.querySelector('.legend-content');
    legend.style.display = 'none';
}

// Tambahkan event listener untuk acara browser-print-start
map.on("browser-print-start", function(e) {
    // Menampilkan legenda pada peta cetak
    showLegend();
    
    // Membuat kontrol legenda dan menambahkannya ke peta cetak
    var legendControl = L.control({ position: 'bottomright' });
    
    legendControl.onAdd = function(map) {
        var legendDiv = L.DomUtil.create('div', 'legend');
        legendDiv.innerHTML = document.querySelector('.legend-content').innerHTML;
        return legendDiv;
    };

    legendControl.addTo(e.printMap);
});





L.control.browserPrint({
    
    printLayer: L.control.layers(baseLayers, null, { collapsed: false }),
    onPrintStart: function () {
        var legendContainer = document.getElementById('legend-container');
        legendContainer.style.display = 'block'; // Tampilkan legenda saat mencetak
    },
    onPrintEnd: function () {
        var legendContainer = document.getElementById('legend-container');
        legendContainer.style.display = 'none'; // Sembunyikan legenda setelah mencetak
    },
}).addTo(map);






</script>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-8">
            
            <div class="card">
            <div class="card-header">
                <h4>Halo , Selamat Datang {{ admin.nama_admin }}</h4>

            </div>





            



        </div>
        
        </div>
    </div>
    
    
            </div>


    <div class="col-12 col-lg-3">
        <div class="card">
        <div class="card-body py-4 px-4">
            <div class="d-flex align-items-center">
                <div class="avatar avatar-xl">
                    {% if admin.gambar %}
                        <img src="{{ admin.gambar.url }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%;" alt="Gambar Admin">
                    {% endif %}
                    </div>
            <div class="ms-3 name">
                <h5 class="font-bold mb-1">{{ admin.nama_admin }}</h5>
                
                <h7 class="text-muted mb-0">{{ admin.divisi }}</h7>
            </div>
            </div>
        </div>
        </div>
        <div class="card">
        <div class="card-header">
            <h4>Pengajuan Baru</h4>
        </div>
        <ul style="list-style: none; justify-self: center;">
                {% for pengajuan in latest_pengajuan %}
                    <li style="center"><a href="{% url 'petaroutingpengajuan' pengajuan.pengajuanid %}"   style="color: #000000">{{ pengajuan.masyarakatid.nama }}</a></li>
                {% endfor %}
                </ul>
        <div class="card-content pb-4">
            <div class="recent-message d-flex px-4 py-3">
            
        </div>
        </div>
        <div class="card">
        <div class="card-header">
            <h4>Kerusakan Baru</h4>
        </div>
        <ul style="list-style: none; justify-self: center;">
                {% for kerusakan in latest_kerusakan %}
                    <li style="center"><a href="{% url 'petaroutingkerusakan' kerusakan.kerusakanid %}" style="color: #000000">{{ kerusakan.masyarakatid.nama }}</a></li>
                {% endfor %}
                </ul>
        

        

        </div>
    </div>
    </section>
    <div class="row">
        <div class="col-12">
                    <div class="card">
                    <div class="card-header">
                        <h4>Statistik Pembangunan berdasarkan Kondisi</h4>
                    </div>
                    <div class="card-body">
                        <div id="area"></div>
                    </div>
                    </div>
                </div>
    </div>
</div>

{% else %}
    <!-- Arahkan pengguna ke halaman login -->
    <p>Silakan <a href="{% url 'masuk' %}">login</a> untuk mengakses halaman ini.</p>
{% endif %}
<script src="{% static 'assets/extensions/dayjs/dayjs.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    var chartData = {{ chart_data|safe }};
        var chartCategories = {{ chart_categories|safe }};

        var options = {
            series: chartData,
            chart: {
                height: 350,
                type: 'area'
            },
            dataLabels: {
            enabled: false,
        },
            xaxis: {
                categories: chartCategories,
                type: "datetime",
                labels: {
                    formatter: function(val) {
                        return new Date(val).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    }
                }
            },
            yaxis: {
                title: {
                    text: "Jumlah Data",
                },
                labels: {
                    formatter: function (val) {
                        return parseInt(val).toString();
                    }
                }
            },
            
        };

        var chart = new ApexCharts(document.querySelector("#area"), options);
        chart.render();
</script>


{% endblock content %}